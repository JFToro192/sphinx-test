.. _4.2:

Hazard Mapping 
=======================================
In this section we will revisit some of the contents and tools introduced in previous chapters presenting two different scenarios to perform a hazard assessment.

This is a new paragraph.

**This is some random test meant to be bold**

The following statemens present the syntax for creating different type of boxes to add comments to the documentation.

.. code-block:: php

   $a = 'b';

`result = (1 + x) * 32`

``:literal:`␠abc```

This is a math expression :math:`\alpha > \beta`

.. math::

    n_{\mathrm{offset}} = \sum_{k=0}^{N-1} s_k n_k

.. note::

    To continue with the lecture, you are requested to `download and install QGIS <https://qgis.org/en/site/forusers/download.html>`_ on your computer (QGIS LTR version is suggested)

.. important::

    To continue with the lecture, you are requested to `download and install QGIS <https://qgis.org/en/site/forusers/download.html>`_ on your computer (QGIS LTR version is suggested)

.. warning::

    To continue with the lecture, you are requested to `download and install QGIS <https://qgis.org/en/site/forusers/download.html>`_ on your computer (QGIS LTR version is suggested)

Here there is a new citation [1]_:

.. [1] Bolstad, P. (2016). GIS fundamentals: A first text on geographic information systems. Eider (PressMinnesota).

Layout of the AOI with the flood/fire event of that has been analysed in the exercise, classify buildings and roads by the impact. The layout should include the table with the number of affected buildings and length of the closed roads as well as all elements required by a complete map. 

:numref:`4.2.1` presents the files structure to be used for both of the exercises to manage the different inputs and outputs.

.. _4.2.1:
.. figure:: /img/4/4.2.1.png
   :scale: 100%
   :align: center

   QGIS project folders and layers structure

Flood Mapping
-------------

* **Overview**

Flood mapping helps to estimate the flood extent on a large scale. It is an important tool during different phases of an emergency giving support to coordinate recovery activities, rehabilitation and prevention measures for such events. In this practice, we will use Sentinel-imagery to determine the flood extent for a specific study case. The flood extent estimates will serve as well for carrying out a damage assessment.

* **Objective**

The purpose of this practice is to guide you on assessing the exposure of a human settlement in a flood event.
   
   *  Disaster type: Flood
   *	Disaster Cycle Phase: Recovery and Reconstruction, Relief and Response

* **Test Site**

   **TODO**: Add a Figure of the location

* **Context**

*“Since the first hours of the 3rd of October 2020 an intense weather perturbation affected the North of Italy, with heavy rain and strong winds. Both red and orange alerts were issued by the regional and National Civil Protection. The greatest damages are reported in the Liguria region, and in the northern and western part of Piedmont region where the amount of the precipitation recorded exceeds the historical rate since 1958. The heavy rainfall has caused the overflow of several rivers and flooding of many areas. The overflow of the Sesia river in the Piedmont region caused interruption of roads, the collapse of a bridge and the flooding of several areas. Two deaths have also been reported.”* (CEMS Rapid Mapping Activation: `EMRS-468 <https://emergency.copernicus.eu/mapping/list-of-components/EMSR468>`_)

* **Applicability**

   **TODO**:

* **Methodology**
   
   **TODO**:

* **Sentinel-2 Imagery**

   * True colors band for the pre- and post event of the AOI.

* **Strenghts and Limitations:**

   **TODO**: Add strenghts and Limitations

* **Workflow** 

.. _4.2.1.1:
.. figure:: /img/4/4.2.1.1.png
   :scale: 60%
   :align: center

   Flood mapping exercise workflow

* **Copernicus EMS - Rapid Mapping**

Before starting to do the exercise, it is worth to mention how it was possible to identify the study case and the Area of Interest (AOI). For this purpose, we reviewed the Rapid Maping list of activations published byt the Copernicus Emergency Management Service (CEMS) available in this `link <https://emergency.copernicus.eu/mapping/list-of-activations-rapid>`_. In :numref:`4.2.1.2`, you can find the different parameters set to query the activation of interest. Here, select ``Flood`` as event type **(1)** and ``Italy`` as the affected country **(2)**. After the list of activations is upated with the defined parameters select the activation with the code EMSR468 (named *Flood in Piedmont region, Italy*) by clicking on its title **(3)**.

.. _4.2.1.2:
.. figure:: /img/4/4.2.1.2.png
   :align: center

   Copernicus Rapid Mapping List of Activations - Flood events in Italy.

.. note::

   In case you would like to search a different activation, there are other parameters which can help you to limit the query.
   
   * **Title**: define logical operators (e.g. ``equal``, ``not equal``, ``contains``, etc. ) to search for specify keywords in the title of the activation.
   * **Activation Status**: define the current status of the activation. ``Open`` (On-going) or ``closed`` (Production finished)
   * **Event type**: select within a list of events the one of your interest.
   * **Event Start/End date**: define a period to query the activations. 
   * **Affected countries**: Select one or multiple countries to query the activations. To select multiple elements from the list hold the **ctrl** key.

   Once introduced the parameters the website execute the query for the matching activations. If for any reason the table do not update, click on the apply button.
   For more information about the rapid mapping activities refer to the `Online Manual for Rapid Mapping Products <https://emergency.copernicus.eu/mapping/ems/online-manual-rapid-mapping-products>`_.

At this point, you should have reached the activation summary with details of the characteristics of the activation and the different products delivered for the activation (see :numref:`4.2.1.3`). In this case, the activation involved multiple locations but for the exercise we will dedicate our attention to the delineation products in Vercelli. Here, there is the possibility to filter the products according to the typology and the AOI. Select ``Vercelli`` **(1)** as your AOI and ``[EMSR468] Vercelli: Delineation Product, version 1, release 1, RTP`` **(2)** as your product of interest.

.. _4.2.1.3:
.. figure:: /img/4/4.2.1.3.png
   :align: center

   Copernicus EMS Rapid Mapping Flood in Piedmont Region, Italy (`EMRS468 <https://emergency.copernicus.eu/mapping/list-of-components/EMSR468>`_).

Inside the product page, as seen in :numref:`4.2.1.4`, you will have the option for:

   * selecting the maps delivered by CEMS in **PDF (1)** and **JPEG** format
   * downloading the CEMS vector layers produced for the delineation product by selecting the **ZIP (2)** file, accepting the disclaimers on the use of the prooducts, and ``download`` **(3)** the package.

Now, you can make use of the different layers produced for de AOI delineating the flooded area.

.. _4.2.1.4:
.. figure:: /img/4/4.2.1.4.png
   :align: center

   Copernicus EMS Rapid Mapping, Delineation product, Flood in Piedmont Region, Italy. Vector Package Download (`Delineation EMRS468 <https://emergency.copernicus.eu/mapping/ems-product-component/EMSR468_AOI05_DEL_PRODUCT_r1_RTP01/1>`_).

* **Data Download - EOBrowser**

Next, we can proceed with the outline presented in :numref:`4.2.1.1`.

Let us go to the `EOBrowser <https://apps.sentinel-hub.com/eo-browser/?zoom=13&lat=40.82128&lng=14.60667&themeId=DEFAULT-THEME>`_ platform to retrieve the Sentinel-2 optical satellite imagery for the AOI. Once that you have accessed your credentials you will have access not only to visualizing the Sentinel-Hub catalogue in the browser, but also the possibility to download the datasets.

.. warning::
   
   This part of the practice imply that you have followed the lectures on “Sentinel Hub EO Browser” (https://gis4schools-rs.readthedocs.io/en/latest/rs_satelliteimages.html#) and that you are a registered “Sentinel-hub” user.

Now, we can define the querying parameters for our datasets of interest for the pre- and post-event of the flood event (see :numref:`4.2.1.5`):

   * Use the search bar located at the top-right of you screen and search for ``Vercelli, VC, Italia`` **(1)**. Alternatively, you can move within the map canvas if you are familiar with the location, or you can upload a KML or GEOJSON file with the area of interest to identify the AOI.
   * Data Source: ``Sentinel-2`` **(2)**

      * ``Advanced Search:`` **(3)** → ``L2A (atmospherically corrected)`` **(4)**
   * Time Range:

      * Start date: 2020-09-20 **(5)**
      * End date: 2020-10-03 **(6)**

After completely fill in the fields, click on the ``search`` **(7)** button to retrive the imagery.

.. note::

   The Top of Atmosphere (TOA) corrections aim at separating the reflectance emitted for objects on the Earth’s surface from atmospheric disturbances that are part of the reflected energy recorded by the sensor. (https://www.un-spider.org/node/10958)

.. _4.2.1.5:
.. figure:: /img/4/4.2.1.5.png
   :align: center

   EOBrowser viewer. CEMS Rapid Mapping activation EMRS468 Flood Event AOI.

On the left-side of the viewer, select the image for the September 28, 2020 by clicking on the ``visualize`` (1) button in :numref:`4.2.1.6`. Notice that while hovering over the different available imagery the polygon representing the image coverage will change of color. This polygons visualization enables the possibility to observe that the imagery encloses the AOI.

.. _4.2.1.6:
.. figure:: /img/4/4.2.1.6.png
   :align: center

   EOBrowser viewer. Available imagery fulfilling the parameters.

Having selected the image, you will enable multiple functionalities to interact with the map and the dataset (see :numref:`4.2.1.7`). Let us proceed to download the imagery. Click on the download function **(4)** to open the download window. Then, access the ``analytical`` tab to define the data format and typology of your preference for downloading the data. In this case, input the following parameters to donload the data:

   * Image format: ``TIFF (32-bit float)`` **(8)**
   * Image resolution: ``HIGH`` **(9)**
   * Coordinate system: ``WGS 84 (EPSG:4326)`` **(10)**
   * Layers: ``True Color`` **(11)**

Then, click the ``Download`` **(12)** button, that will execute the download of the requested datasets. Each of the selected layer(s) are compressed into a ZIP file. By default the files are downloaded by the name of ``EO_Browser_images.zip``.
Rename the file as ``EO_Browser_images_pre.zip``. Move the file under the ``Chapter 4\Copernicus_EMS_Exercise\study cases\EMSR468 - Flood Scenario\EOBrowser-Scihub``.

.. important::

   The downloaded images are relative to the current extent of the map viewer. When retrieving the data for a certain extent, avoid dragging or zooming the map view as it will change extent covered by the images. 
   
   Alternatively, you can draw within the map canvas if you are familiar with the location, or you can upload a KML or GEOJSON file with the area of interest to identify the AOI.

.. _4.2.1.7:
.. figure:: /img/4/4.2.1.7.png
   :align: center

   EOBrowser viewer. Flood event area of interest data download.

.. note::

   For more information about the functionalities provided by the satellite imagery viewer seen in :numref:`4.2.1.7`, such as ``define an AOI`` **(1)**, ``Mark a point of interest`` **(2)**, ``Measure`` **(3)**, ``Download image`` **(4)**, ``Create time lapse animation`` **(5)** and ``Visualize terrain in 3d`` **(6)**, visit the `EOBrowser user-guide <https://www.sentinel-hub.com/explore/eobrowser/user-guide/>`_. 

:numref:`4.2.1.8` present the pre- and post event imagery (atmospherically corrected) for the true colors of the imagery. Having imagery in different phases of the emergency allow to identify which is the hydrography of the AOI in normalcy with respect to the flooded areas. To query different images in time, EOBrowser provide two options to reach the imagery contained within the time span defined in previous steps. The first option is to return to the ``Discover`` **(1)** tab to reach the list of images and visualize a different image. And the second option, is to use the arrows presented next to the date to move backwards/forwards **(2)** in time to visualize the available imagery. Here, you will have the possibility to search suitable, cloud-free, imagery of your AOI for the later processing.

.. _4.2.1.8:
.. figure:: /img/4/4.2.1.8.png
   :align: center

   EOBrowser viewer. Flood event pre- (2020-09-28) and post-event (2020-10-03) view.

Fire Mapping
------------

In this section we will dedicate our attention on the processing of Sentinel-2 satellite imagery to build a hazard map assessing the damage from a fire event in the vicinity of an urban area.

* **Overview**

A wildfire is a rapidly spreading fire that also occur in woodland areas. Annual dry seasons or drought provide an ideal environment for biomass and dry conditions to combine. Ignition sources for wildfires can relate to natural events, such as lightning strikes or lava flow. Unfortunately, they can also be man-made, resulting from the burning of debris, unattended campfires and intentional arson.

Wildfires can result in the loss of human life, wildlife, and impact directly, or indirectly, different ecological processes due to the removal of the vegetation layer (Petropoulos, Griffiths, & Kalivas, 2014). Therefore, it is essential the assessment of the severity of the impacted areas. This practice aims at assessing an affected area using remote sensing tools. The methodology will benefit from the use of the open satellite imagery published at the Copernicus Sci-Hub. Here, using Sentinel-2 imagery, you will model the severity of a wildfire in the Campania Region in Italy (in the vicinity of Sarno). The severity assessment considers the comparison of pre- and post-event imagery by computing the Normalized Burnt Ratio (NBR) on each scenario.

* **Objective**

The purpose of this practice is to guide you on assessing the post-fire burnt severity.

   * Disaster type: Wildfire
   * Disaster Cycle Phase: Recovery and Reconstruction, Relief and Response

* **Test Site**

   **TODO**: Add a Figure of the location

* **Context**

*“On 15/09/2019, a forest fire affected the municipality of Sarno (Salerno) in Italy, in the area of the Monte Saretto. The fire spread over the mountain behind the town of Sarno and for this reason almost 200 people have been evacuated. After a first analysis of the event, over 90% of the Sarno pine forest has been affected.”* (CEMS Rapid Mapping Activation: `EMRS-394 <https://emergency.copernicus.eu/mapping/list-of-components/EMSR394>`_)

* **Applicability**

Burnt severity data and maps can aid the development of emergency rehabilitation and restoration plans, post-fire. The proposed methodology is recommended for assessing the burn severity of large areas affected by wildfires. The burn severity can also be used to estimate soil burn severity and the likelihood of future downstream impacts due to flooding landslides and soil erosion.

Wildfires: Global Critical Issues:

   * Loss of human life and property
   * Land cover dynamics (on temporal and spatial scale), soil structure, composition and competition of species (Lhermitte et al., 2011)
   * Air pollution
   * Habitat loss
   * Hydrological regime changes and increased risk of landslides and floods
   * Increased frequency, duration and severity due to fire suppression methods and climate change

The practice makes use of Sentinel-2 imagery. 

Burn severity monitoring we will make use of Sentinel-2 Near Infrared (NIR) and Shortwave Infrared (SWI) bands. These bands have a spatial resolution of 20m.

* **Methodology**
   
The practice makes use of Sentinel-2 imagery. 

For burn severity monitoring we will make use of Sentinel-2 Near Infrared (NIR) and Shortwave Infrared (SWI) bands. These bands have a spatial resolution of 20m.

.. _4.2.2.1:
.. figure:: /img/4/4.2.2.1.png
   :scale: 100%
   :align: center
   
   --Illustration of fire intensity versus burn severity (Source: US Forest Service)

A measurement to highlight burnt areas is the Normalized Burnt Ratio (NBR), which tries to identify the effects of a fire in an area (after the combustion process). The NBR is an index designed to expose burnt areas in large fire zones. 

.. _4.2.2.2:
.. figure:: /img/4/4.2.2.2.png
   :scale: 100%
   :align: center
   
   --Comparison of the spectral response of healthy vegetation and burned areas (Source: US Forest Service)

The healthy vegetation shows a high reflectance in the NIR, and a low reflectance in the SWIR portion of the spectrum. On the other hand, there is the opposite behaviour in burnt areas. The NBR benefits from this difference in the spectrum to highlight a burnt area through the following relationship.

When the NBR value is high it indicates a healthy vegetation. While low NBR values indicate bare ground and recently burnt areas. Non-burnt areas area generally attributed a value of zero.

The difference between the pre-fire and post-fire NBR can be used to estimate the severity of the burnt area. This measurement is known as the Burn Severity. Higher values of this estimation indicate more severely damaged vegetation.

Burn Severity values can vary from case to case, and so, if possible, interpretation in specific instances should also be carried out through field assessment; in order to obtain the best results. However, the United States Geological Survey (USGS) proposed a classification table to interpret the burn severity presented in :numref:`4.2.1.t`.

.. _4.2.1.t:
.. table:: USGS burn severity ranges classification
   :align: center

   +--------------------------+------------+-------+------------------------+
   | USGS dNBR classification | HEX Color  | Color | Label                  |
   | (Value <= dNBR)          |            |       | (Severity Level)       |
   +==========================+============+=======+========================+
   | -0.1                     | #29BD2E    |  ...  | Unburned               |
   +--------------------------+------------+-------+------------------------+
   | 0.27                     | #FFDE00    |  ...  | Low Severity           |
   +--------------------------+------------+-------+------------------------+
   | 0.44                     | #FF9100    |  ...  | Moderate-Low Severity  | 
   +--------------------------+------------+-------+------------------------+
   | 0.66                     | #E3003B    |  ...  | Moderate-High Severity |
   +--------------------------+------------+-------+------------------------+
   | 1.3                      | #9D00C4    |  ...  | High Severity          |
   +--------------------------+------------+-------+------------------------+

* **Sentinel-2 Imagery**

The Sentinel-2 imagery required to develop this practice is:

   * NIR and SWIR images for Sentinel-2 are the bands 8A and 12, correspondingly.
   * The pre-event imagery was retrieved for the 03/09/2020.
   * The post-event imagery was retrieved for the 14/09/2020.


* **Strenghts and Limitations:**

Strenghts:
   
   * The recommended workflow can be easily applied to different areas.

Limitations:
   
   * Accuracy of the assessment can be determined through field assessment.
   * The methodology is suitable to assess large areas.

* **Workflow** 

.. _4.2.2.3:
.. figure:: /img/4/4.2.2.3.png
   :scale: 60%
   :align: center
   
   --Fire mapping exercise workflow

Other Useful Resources
----------------------

* **Global Human Settlement Layer**

The `Global Human Settlement Layer (GHSL) <https://ghsl.jrc.ec.europa.eu/>`_ project produces timely geospatial information of human presence on the planet. Through the used of spatial data mining technologies, the project harvests information with evidence-based analytics and knowledge. The information is exposed as built-up maps, population density maps and settlement maps. The GHSL profits from the use of heterogeneous data such as satellite imagery, census data, and volunteered geographic information.

.. _4.2.3.1:
.. figure:: /img/4/4.2.3.1.png
   :align: center
   
   --Global Human Settlement Layer website, https://ghsl.jrc.ec.europa.eu/

* **Global Human Settlement Layer (GHSL) - Population**

The `Global Human Settlement Layer Population layer (GHSL-POP ) <https://ghsl.jrc.ec.europa.eu/ghs_pop2019.php>`_ [2]_ is a spatial raster dataset depicting the distribution and density of the population expressed in number of people by cell. The production of this imagery is possible through the disaggregation of census or administrative spatial data into cells. Values are expressed as decimals (Float) and represent the absolute number of inhabitants of the cell. The residential population targets the years 1975, 1990, 2000 and 2015. The GHSL-POP datasets can be described by: 

   * Product name: GHS_POP_MT_GLOBE_R2019A
   * Coordinate System: World Mollweide (EPSG:54009), WGS (EPSG:4326)
   * Resolution available:  250m, 1km, 9 arcsec, 30 arcsec

The naming convention for the GHSL-POP datasets is defined as *“{Product Name}_{Coordinate System}_{Resolution}_{Version}”* (e.g. GHS_POP_E2015_GLOBE_R2019A_4326_9SS_V1_0, that is the version 1 of GHSL-POP dataset for 2015 referred to WGS84 with a resolution of 9 arcsec). 

.. note:: ``NoData`` cells are assigned -200 as value.

After following the steps as presented in :numref:`4.2.3.1`, you will find a web viewer visualizing the tiles for the GHSL-POP products. At this point you can click on the tiles of enclosing your area of interest and execute the download of the raster dataset.

.. _4.2.3.2:
.. figure:: /img/4/4.2.3.2.png
   :align: center
   
   --Global Human Settlement Layer Population Tiles Web Viewer, https://ghsl.jrc.ec.europa.eu/ghs_pop2019.php

.. [2] Schiavina, Marcello; Freire, Sergio; MacManus, Kytt (2019): GHS population grid multitemporal (1975, 1990, 2000, 2015) R2019A. European Commission, Joint Research Centre (JRC) DOI: 10.2905/42E8BE89-54FF-464E-BE7B-BF9E64DA5218 PID: http://data.europa.eu/89h/0c6b9751-a71f-4062-830b-43c9f432370f.

Eventually this can become a single note or important comment to mention additional material.

.. note::

   Add the reference material for the lecture.